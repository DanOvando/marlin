<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Setting &amp; Understanding Movement Rates ‚Ä¢ marlin</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Setting &amp; Understanding Movement Rates">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">marlin</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/dynamic-habitat.html">Set Dynamic Habitats</a></li>
    <li><a class="dropdown-item" href="../articles/fleet-management.html">Manage Catch and Effort of Fleets</a></li>
    <li><a class="dropdown-item" href="../articles/Invertebrates.html">Invertebrates</a></li>
    <li><a class="dropdown-item" href="../articles/manual_fleets.html">Manual Fishing Grounds and Effort Allocation</a></li>
    <li><a class="dropdown-item" href="../articles/measure_gradients.html">Measure MPA Gradients</a></li>
    <li><a class="dropdown-item" href="../articles/movement-rates.html">Setting &amp; Understanding Movement Rates</a></li>
    <li><a class="dropdown-item" href="../articles/MSE.html">Management Strategy Evaluation (sort of)</a></li>
    <li><a class="dropdown-item" href="../articles/port-distance.html">Setting and Using Distance from Port</a></li>
    <li><a class="dropdown-item" href="../articles/rectifier.html">Don't Be a Square</a></li>
    <li><a class="dropdown-item" href="../articles/Setting-Selectivity.html">Setting Selectivity</a></li>
    <li><a class="dropdown-item" href="../articles/Working-with-Recruitment-Deviates.html">Working with Recruitment Deviates</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/danovando/marlin/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Setting &amp; Understanding Movement Rates</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/danovando/marlin/blob/HEAD/vignettes/movement-rates.Rmd" class="external-link"><code>vignettes/movement-rates.Rmd</code></a></small>
      <div class="d-none name"><code>movement-rates.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danovando.github.io/marlin/">marlin</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggforce.data-imaginist.com" class="external-link">ggforce</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="../reference/theme_marlin.html">theme_marlin</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code>marlin</code>‚Äôs movement dynamics are based on a
continuous-time Markov chain (CTMC), as described in <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/faf.12592?casa_token=sMbD1uKODM8AAAAA:XpCKSWY9dYaQsxvtanHydjc520drhvuHd3UUjCvqTqL8fqB36iJTgUdCa5J-jkrTDj1vLzwoHQF8AXs" class="external-link">Thorston
et al (2021)</a>. The advantate of the CTMC model is that it allows for
movement to be broken down into three components of <em>advection</em>
(drifting with currents), <em>taxis</em> (active movement towards
preferred habitat), and <em>diffusion</em> (essentially remaining
variation in movement not explained by advection or taxis). For now,
<code>marlin</code> focuses just on the diffusion and taxis components
of this model, assuming that advection is zero, though future extensions
could easily incorporate advection vectors from oceanographic models. In
this way, <code>marlin</code> allows users to run anything from a simple
Gaussian dispersal kernel up to a system governed by species that
passively diffuse out from a core habitat defined by a dynamic thermal
range.</p>
<div class="section level2">
<h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h2>
<p><code>marlin</code>‚Äôs movement dynamics are based on a
continuous-time Markov chain (CTMC), as described in <span class="citation">@thorson2021a</span>. Within this framework, the model
allows for movement to be broken down into three components of
<em>advection</em> (drifting with currents), <em>taxis</em> (active
movement towards preferred habitat), and <em>diffusion</em> (essentially
remaining variation in movement not explained by advection or taxis).
For now, <code>marlin</code> focuses just on the diffusion and taxis
components of this model, assuming that advection is zero, though future
extensions could easily incorporate advection vectors from oceanographic
models. In this way, <code>marlin</code> allows users to run anything
from a simple Gaussian dispersal kernel up to a system governed by
species that passively diffuse out from a core habitat defined by a
dynamic thermal range.</p>
<p>We provide a brief overview of the the general CTMC method here (see
<span class="citation">@thorson2021a</span> for a detailed description).
Under this framework, movement of individuals from each patch to each
other patch in the system in a given timestep <em>t</em> for life stage
<em>a</em> of species <em>s</em> is defined by a movement matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùêå</mi><mrow><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">\pmb{M}_{t,s,a}</annotation></semantics></math>.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùêå</mi><mrow><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">\pmb{M}_{t,s,a}</annotation></semantics></math>
is calculated as a function of diffusion
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêÉ</mi><annotation encoding="application/x-tex">\pmb{D}</annotation></semantics></math>
and taxis
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùõï</mi><annotation encoding="application/x-tex">\pmb{\tau}</annotation></semantics></math>
matrices scaled by the width of the time step
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œî</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\Delta_{t}</annotation></semantics></math>
and the length of the edge of each patch
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œî</mi><mi>d</mi></msub><annotation encoding="application/x-tex">\Delta_d</annotation></semantics></math>
that the model is running under. This parameterization allows users to
set the effective area of the spatial domain through two avenues; the
number of patches, which effectively scales the resolution of the model,
and the area of each patch, which scales the spatial extent of the
simulation.</p>
<p>The individual components (<em>M</em>) of the movement matrix
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêå</mi><annotation encoding="application/x-tex">\pmb{M}</annotation></semantics></math>)
are filled based on an adjacency matrix, which defines whether two
patches are both adjacent and water (as opposed to land or another
physical barrier), a diffusion rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
defined in units of area of a patch per unit of time, and a habitat
preference function <em>H</em> in units of length of a side of a patch
per unit time. For example, if we are defining the time units as years
and the distance units as kilometers, for a tuna
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
might be 1,000
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mi>K</mi><msup><mi>M</mi><mn>2</mn></msup></mrow><mrow><mi>Y</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></mfrac><annotation encoding="application/x-tex">\frac{KM^2}{Year}</annotation></semantics></math>.
We then use parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œî</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\Delta_{t}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œî</mi><mi>d</mi></msub><annotation encoding="application/x-tex">\Delta_{d}</annotation></semantics></math>
parameters to translate the diffusion rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
to match the time step and patch size used in a simulation. For example,
if we were to run a model on a monthly timestep given time units of
years, then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œî</mi><mi>t</mi></msub><mo>=</mo><mn>1</mn><mi>/</mi><mn>12</mn><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">\Delta_{t} = 1/12 years</annotation></semantics></math>.
If one square patch in the simulation has an area of 100km<sup>2</sup>,
then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œî</mi><mi>d</mi></msub><mo>=</mo><mn>10</mn><mi>K</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">\Delta_d = 10KM</annotation></semantics></math>.
This ‚Äúscale free‚Äù parameterization means that appropriate value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
can be identified for a species and then set, regardless of the time
step or patch size used in the simulation model itself. The taxis
component of the movement process is a function of the difference in
habitat quality <em>H</em>. The habitat preference function itself can
take any form the user wishes. Exponentiating the difference in the
habitat preference function between patches turns the taxis matrix into
a multiplier of the diffusion rate <em>D</em>. As such, when creating
habitat layers for simulation, users can tune the scale of the habitat
gradient function to result in realistic multipliers of the diffusion
rate. This parameterization ensure that the off-diagonal elements of the
movement matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùêå</mi><mrow><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">\pmb{M}_{t,s,a}</annotation></semantics></math>
are all non-negative, a requirement of the CTMC method.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>p</mi><mn>1</mn><mo>,</mo><mi>p</mi><mn>2</mn><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><msub><mi>Œî</mi><mi>t</mi></msub><msubsup><mi>Œî</mi><mi>d</mi><mn>2</mn></msubsup></mfrac><mi>D</mi><msup><mi>e</mi><mfrac><mrow><msub><mi>Œî</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mn>2</mn><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mn>1</mn><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><msub><mi>Œî</mi><mi>d</mi></msub></mfrac></msup></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if p2 and p1 are adjacent</mtext></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>‚àí</mi><munder><mo>‚àë</mo><mrow><mi>p</mi><mi>‚Ä≤</mi><mo>‚â†</mo><mi>p</mi><mn>1</mn></mrow></munder><msub><mi>M</mi><mrow><mi>p</mi><mn>1</mn><mo>,</mo><mi>p</mi><mn>2</mn><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if p1 = p2</mtext></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise.</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex"> 
M_{p1,p2,t,s,a} = \begin{cases}
      = \frac{\Delta_{t}}{\Delta_{d}^2}De^{\frac{\Delta_t(H(p2,t,s,a) - H(p1,t,s,a))}{\Delta_d}} &amp; \text{if p2 and p1 are adjacent}\\
     = -\sum_{p' \neq p1} M_{p1,p2,t,s,a} &amp; \text{if p1 = p2}\\
     = 0 &amp; \text{otherwise.}
\end{cases}
</annotation></semantics></math> {#eq-diffusion}</p>
<p>For both the diffusion and taxis matrices, we allow for the inclusion
of physical barriers to movement (i.e.¬†land). Pairs of patches that are
adjacent but in which one or both patches are a barrier to movement are
set as non-adjacent. The CTMC model then produces movement dynamics that
move around barriers rather than over them. This is different than
setting habitat in a patch to zero; an animal will not preferentially
move towards a patch with zero habitat all else being equal, but can
move over a patch with zero habitat towards another better patch. An
example might be a species that lives and feeds on coastal habitats
transiting through a patch of open ocean to reach a new feeding ground.
In contrast, a physical barrier represents something like a peninsula
that an animal must move around to transit from one side to another.</p>
<p>The movement of individuals across patches is then calculated by
matrix multiplication of the pre-movement vector of the number of
individuals
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêß</mi><annotation encoding="application/x-tex">\pmb{n}</annotation></semantics></math>)
of species <em>s</em> at age <em>a</em> in time step <em>t</em> across
all patches <em>p</em> times the matrix exponential of the movement
matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêå</mi><annotation encoding="application/x-tex">\pmb{M}</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêß</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub><mo>=</mo><msub><mi>ùêß</mi><mrow><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub><msup><mi>e</mi><msub><mi>ùêå</mi><mrow><mi>t</mi><mo>,</mo><mi>s</mi><mo>,</mo><mi>a</mi></mrow></msub></msup></mrow><annotation encoding="application/x-tex">
\pmb{n}_{t+1,s,a} = \pmb{n}_{t,s,a}e^{\pmb{M}_{t,s,a}}
</annotation></semantics></math> {#eq-movement}</p>
</div>
<div class="section level2">
<h2 id="setting-movement-parameter-values">Setting Movement Parameter Values<a class="anchor" aria-label="anchor" href="#setting-movement-parameter-values"></a>
</h2>
<p>One of the advantages of the CTMC method is that it‚Äôs parameters can
in theory be estimated from data. However, in many cases users will not
have the resources to directly estimate movement parameters, and will
need to decide on logical values on their own.</p>
<p>Movement enters marlin in two ways; through the dispersal parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
and the ratio of habitat gradients. Let‚Äôs focus first on setting up the
dispersal parameter.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
is in units of distance<sup>2</sup> / time. So if one was running a
model using time units of years and distance of km^2,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
might be 100km^2/yeark meaning that a fish can diffuse over an area of
100km<sup>2</sup> over the span of a year. Values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
can then be set through literature review or best judgement given the
species in question.</p>
<p>Once we have set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>,
<code>marlin</code> then estimates the correct diffusion matrix given
the spatial and temporal resolution of the simulation itself.</p>
<p>Let‚Äôs set</p>
<ul>
<li>a 20x20 simulation grid</li>
<li>width of a square cell side
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œî</mi><mi>d</mi></msub><annotation encoding="application/x-tex">\Delta_d</annotation></semantics></math>
of 5km</li>
<li>a time step
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œî</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\Delta_t</annotation></semantics></math>
of one year</li>
<li>a diffusion parameter <em>D</em> of 100 km<sup>2</sup>/year</li>
</ul>
<p>While we could run this through <code>marlin</code>, we‚Äôre going to
actually step through the calculations here so readers can get a sense
for what is actually happening in the model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">resolution</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># cells per side</span></span>
<span></span>
<span><span class="va">patches</span> <span class="op">&lt;-</span> <span class="va">resolution</span><span class="op">^</span><span class="fl">2</span> <span class="co"># number of patches</span></span>
<span></span>
<span><span class="va">delta_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="co"># length of a cell side in km</span></span>
<span></span>
<span><span class="va">patch_area</span> <span class="op">=</span> <span class="va">delta_d</span><span class="op">^</span><span class="fl">2</span> <span class="co"># in units of km^2/patch</span></span>
<span></span>
<span><span class="va">simulation_area</span> <span class="op">&lt;-</span> <span class="va">patch_area</span> <span class="op">*</span> <span class="va">patches</span></span>
<span></span>
<span><span class="va">delta_t</span> <span class="op">=</span> <span class="fl">1</span> <span class="co"># length of one time step in the simulation in units of years </span></span>
<span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">4</span><span class="op">*</span><span class="va">patch_area</span><span class="op">)</span> <span class="co"># km^2  / year</span></span></code></pre></div>
<p>We‚Äôre now going to set up an ‚Äúadjacency matrix‚Äù. This is a patches x
patches dimension matrix that has a 1 if two patches are adjacent to
each other, and a 0 if not.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">resolution</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">resolution</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adjacent</span> <span class="op">&lt;-</span> <span class="va">grid</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Mark adjacent cells</span></span>
<span><span class="va">adjacent</span><span class="op">[</span><span class="va">adjacent</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">adjacent</span><span class="op">)</span></span></code></pre></div>
<p><img src="movement-rates_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>We‚Äôll now fill in the diffusion matrix, using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ¥</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\delta_t</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ¥</mi><mi>d</mi></msub><annotation encoding="application/x-tex">\delta_d</annotation></semantics></math>
to translate the diffusion parameter into the correct units.</p>
<p>See Thorson et al.¬†(2021) for details of the math here if you‚Äôre
interested.</p>
<p>The net result of this step is we create an <em>instantaneous
diffusion matrix</em> that will then be used to calculate the total
diffusion probabilities over a <strong>discrete amount of time</strong>
using matrix exponentiation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diffusion_matrix</span> <span class="op">&lt;-</span> <span class="va">adjacent</span> <span class="op">*</span> <span class="va">D</span> <span class="op">*</span> <span class="op">(</span><span class="va">delta_t</span> <span class="op">/</span> <span class="va">delta_d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># adjacent times diffusion rate times simulation units</span></span>
<span></span>
<span><span class="co"># fill in diagonal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span> <span class="op">&lt;-</span>  <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ensure matrix class</span></span>
<span><span class="va">diffusion_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span></span></code></pre></div>
<p><img src="movement-rates_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Now, we‚Äôll use this diffusion model to simulate ths diffusion of some
critters from a central patch to the patches around it.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># put some animals in around the center</span></span>
<span></span>
<span></span>
<span><span class="va">D_patches</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">/</span> <span class="va">patch_area</span> <span class="co"># translate diffusion into units of patches / year</span></span>
<span></span>
<span><span class="va">D_patches_side</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D_patches</span><span class="op">)</span> <span class="co"># side of the diffusion box</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">patches</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">n</span><span class="op">[</span><span class="va">grid</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="va">resolution</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">grid</span><span class="op">$</span><span class="va">y</span> <span class="op">==</span> <span class="va">resolution</span> <span class="op">/</span> <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># add 100 critters to the rough center</span></span>
<span></span>
<span><span class="va">ytmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ytmp</span><span class="op">[</span><span class="va">ytmp</span> <span class="op">&lt;</span> <span class="fl">1e-3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span></span>
<span><span class="va">radius</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="va">D</span> <span class="op">/</span> <span class="va">pi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_next</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span><span class="op">)</span> <span class="co"># calculate the realized diffusion over one time step of the model</span></span>
<span></span>
<span><span class="va">grid</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">n_next</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">delta_d</span>, <span class="va">y</span> <span class="op">*</span> <span class="va">delta_d</span>, fill <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggforce</span><span class="fu">::</span><span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_circle.html" class="external-link">geom_circle</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x0 <span class="op">=</span> <span class="va">resolution</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">delta_d</span>,</span>
<span>    y0 <span class="op">=</span> <span class="va">resolution</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">delta_d</span>, </span>
<span>    r <span class="op">=</span> <span class="va">radius</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance from Bottom Left Corned in KM"</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance from Bottom Left Corned in KM"</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in ggforce::geom_circle(aes(x0 = resolution/2 * delta_d, y0 = resolution/2 * : All aesthetics have length 1, but the data has 400 rows.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">‚Ñπ</span> Please consider using `annotate()` or provide this layer with data containing</span></span>
<span><span class="co">#&gt;   a single row.</span></span></code></pre></div>
<p><img src="movement-rates_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We visualize effect of the the diffusion rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
by simulating dispersal of organisms initially seeded in one central
patch after one year across a range of diffusion rates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diffusion_frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">20</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_diffusion</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">D</span>, <span class="va">resolution</span>, <span class="va">delta_d</span> <span class="op">=</span> <span class="fl">5</span>,<span class="va">delta_t</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span><span class="va">patches</span> <span class="op">&lt;-</span> <span class="va">resolution</span><span class="op">^</span><span class="fl">2</span> <span class="co"># number of patches</span></span>
<span></span>
<span><span class="va">delta_d</span> <span class="op">&lt;-</span> <span class="va">delta_d</span> <span class="co"># length of a cell side in km</span></span>
<span></span>
<span><span class="va">patch_area</span> <span class="op">=</span> <span class="va">delta_d</span><span class="op">^</span><span class="fl">2</span> <span class="co"># in units of km^2/patch</span></span>
<span></span>
<span><span class="va">simulation_area</span> <span class="op">&lt;-</span> <span class="va">patch_area</span> <span class="op">*</span> <span class="va">patches</span></span>
<span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">resolution</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">resolution</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adjacent</span> <span class="op">&lt;-</span> <span class="va">grid</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark adjacent cells</span></span>
<span><span class="va">adjacent</span><span class="op">[</span><span class="va">adjacent</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">diffusion_matrix</span> <span class="op">&lt;-</span> <span class="va">adjacent</span> <span class="op">*</span> <span class="va">D</span> <span class="op">*</span> <span class="op">(</span><span class="va">delta_t</span> <span class="op">/</span> <span class="va">delta_d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># adjacent times diffusion rate times simulation units</span></span>
<span></span>
<span><span class="co"># fill in diagonal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span> <span class="op">&lt;-</span>  <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ensure matrix class</span></span>
<span><span class="va">diffusion_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">D_patches</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">/</span> <span class="va">patch_area</span> <span class="co"># translate diffusion into units of patches / year</span></span>
<span></span>
<span><span class="va">D_patches_side</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D_patches</span><span class="op">)</span> <span class="co"># side of the diffusion box</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">patches</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">n</span><span class="op">[</span><span class="va">grid</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="va">resolution</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">grid</span><span class="op">$</span><span class="va">y</span> <span class="op">==</span> <span class="va">resolution</span> <span class="op">/</span> <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># add 100 critters to the rough center</span></span>
<span></span>
<span><span class="va">ytmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ytmp</span><span class="op">[</span><span class="va">ytmp</span> <span class="op">&lt;</span> <span class="fl">1e-3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span></span>
<span><span class="va">radius</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="va">D</span> <span class="op">/</span> <span class="va">pi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_next</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">diffusion_matrix</span><span class="op">)</span><span class="op">)</span> <span class="co"># calculate the realized diffusion over one time step of the model</span></span>
<span></span>
<span><span class="va">grid</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">n_next</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">diffusion_frame</span> <span class="op">&lt;-</span> <span class="va">diffusion_frame</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>tmp <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">D</span>, <span class="va">sim_diffusion</span>, resolution <span class="op">=</span> <span class="va">resolution</span>, delta_d <span class="op">=</span> <span class="va">delta_d</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diffusion_frame</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">tmp</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">delta_d</span>, <span class="va">y</span> <span class="op">*</span> <span class="va">delta_d</span>, fill <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="st">"N/max(N)"</span>,limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance from Bottom Left Corned in KM"</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance from Bottom Left Corned in KM"</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="movement-rates_files/figure-html/fig-disp-1.png" alt="Diffusion from one central patch after one year for a range of diffusion rates." width="700"><p class="caption">
Diffusion from one central patch after one year for a range of diffusion
rates.
</p>
</div>
<div class="section level3">
<h3 id="adding-in-habitat-preference-through-taxis">Adding in Habitat Preference through Taxis<a class="anchor" aria-label="anchor" href="#adding-in-habitat-preference-through-taxis"></a>
</h3>
<p>The taxis matrix is a function of a habitat function, which must
return habitat values in the same units as the distance, in this case km
/ year.</p>
<p>Taxis is in <code>marlin</code> is modeled in terms of
<strong>difference</strong> in habitat preferences. However, this
produces a complication. In order for the CTMC model to work the
component movemenet matrices must be ‚ÄúMetzler matrices‚Äù, defined as a
matrix where all the off-diagonal elements are non-negative.</p>
<p>So, simply adding a taxis matrix to a diffusion matrix can produce
negative off-diagonal elements if the values of the taxis matrix are
much greater than the diffusion matrix.</p>
<p>To get around this, we use an alternative parameterization of CTMC in
which the habitat gradient produces a multiplier of the diffusion rate.
This has two advantages. First, it ensures that the resulting movement
matrix will not have negative off-diagonal elements and secondly, it
makes it a bit easier to set the scale of the habitat gradient.</p>
<p>As parameterized, the differences in habitat gradient, whether
measured in linear or log space, get exponentiated and then multiplied
by the diffusion rate <em>D</em>. This means that the absolute scale of
the habitat gradient matters less than the scale of their logged
differences. So, when generating simulated habitat layers, you can keep
the dynamics sane by thinking about values that would produce habitat
multipliers that make sense</p>
<p>If you‚Äôre simulating a scallop with a diffusion rate of
0.1km<sup>2</sup>/year, it doesn‚Äôt make much sense to use a habitat
gradient function with a range of 0 to 100, which would produce a taxis
multiplier of exp(100-0) roughly 2e43 KM, meaning you‚Äôve got scallops
flying through space every year.</p>
<p>One trick is to then once you‚Äôve generated a habitat gradient that
you like the overall shape of is to rescale it so that the scale of the
differences makes sense.</p>
<p>Let‚Äôs set up some habitat to see this in action. Suppose that I think
that the most a critter could move towards desirable habitat is three
times the diffusion rate.</p>
<p>First, let‚Äôs just set up some arbitrary habitat</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">habitat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">patches</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">patches</span>,<span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">habitat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">patches</span>,<span class="fl">10</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span>,<span class="va">D</span>,<span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># calculate difference in habitat</span></span>
<span></span>
<span><span class="va">habitat_difference</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">habitat</span>, <span class="va">habitat</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">habitat_difference</span><span class="op">)</span></span></code></pre></div>
<p><img src="movement-rates_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The resulting habitat gradient has values as high as 100, which would
produce illogical results.</p>
<p>We can use the <code>rescale</code> function in R to get things into
a more reasonable space, where the largest differences in habitat would
produce a taxis multiplier of three</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">new_habitat</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html" class="external-link">rescale</a></span><span class="op">(</span><span class="va">habitat</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">habitat_difference</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">new_habitat</span>, <span class="va">new_habitat</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">habitat_difference</span><span class="op">)</span></span></code></pre></div>
<p><img src="movement-rates_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Rescaling like this is clearly distoring the ratios of the habitat
gradient, and so should only be done if you‚Äôre making up habitats for
simulation and want something that makes sense; you should
<strong>not</strong> do this to habitat gradients estimated as part of
an empircal CTMC model!</p>
</div>
</div>
<div class="section level2">
<h2 id="putting-it-all-together">Putting it All Together<a class="anchor" aria-label="anchor" href="#putting-it-all-together"></a>
</h2>
<p>Putting it all together then, we‚Äôll now use both the diffusion and
taxis data to simulate movement over one time step of the model</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">movement_matrix</span> <span class="op">&lt;-</span> <span class="va">adjacent</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">D</span> <span class="op">*</span> <span class="va">delta_t</span> <span class="op">/</span> <span class="va">delta_d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">delta_t</span> <span class="op">*</span> <span class="va">habitat_difference</span><span class="op">)</span> <span class="op">/</span> <span class="va">delta_d</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">movement_matrix</span><span class="op">)</span> <span class="op">&lt;-</span>  <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">movement_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">movement_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">delta_d</span>,<span class="va">y</span> <span class="op">*</span> <span class="va">delta_d</span>,fill <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Number of Fish"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance from Bottom Left Corned in KM"</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance from Bottom Left Corned in KM"</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="movement-rates_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dan Ovando.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
